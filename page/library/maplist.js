mapsData = [
    {
        id: ["eenot", "world", "v1"],
        title: "World by ЕЕнот",
        author: {
            name: "@eenot",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "The best world map for normal and low devices. Very optimized. By developer of EEditor",
        type: "world",
        region: ["europe", "north_africa", "middle_east", "asia", "americas", "africa", "oceania"],
        provinces: 1147,
        features: ["water_provinces", "islands", "straits", "rivers", "shores"],
        status: "completed",
        publishDate: "2025-01-19",
        lastUpdate: "2025-01-19",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["eenot", "moldavia", "v1"],
        title: "Moldavia by ЕЕнот",
        author: {
            name: "@eenot",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Map of Republic of Moldova, Pridnestrovian Moldavian Rupublic and Odesska Oblast of Ukraine",
        type: "country",
        region: ["europe"],
        provinces: 1147,
        features: ["rivers", "shores"],
        status: "completed",
        publishDate: "2025-04-28",
        lastUpdate: "2025-04-28",
        load: "ultralight",
        hiddenScore: 0,
    },
    {
        id: ["bluepum", "enaatme", "v4"],
        title: "Europe+ by Bluepum",
        author: {
            name: "@bluepum",
            link: "https://discord.com/users/277053272959008768",
            color: "#3B83BD"
        },
        description: "Map of Europe, North Africa and Middle East",
        type: "continent",
        region: ["europe", "north_africa", "middle_east"],
        provinces: 734,
        features: ["water_provinces", "islands"],
        status: "in_development",
        publishDate: "2025-04-26",
        lastUpdate: "2025-05-01",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["bluepum", "germany", "v1"],
        title: "Germany by Bluepum",
        author: {
            name: "@bluepum",
            link: "https://discord.com/users/277053272959008768",
            color: "#3B83BD"
        },
        description: "This is the administrative division of Germany",
        type: "country",
        region: ["europe"],
        provinces: 412,
        features: [],
        status: "completed",
        publishDate: "2025-04-24",
        lastUpdate: "2025-04-24",
        load: "mobile",
        hiddenScore: 0,
    },
    {
        id: ["eenot", "arstotzka", "v2"],
        title: "Arstotzka World by ЕЕнот",
        author: {
            name: "@eenot",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Unofficial world map of Paper's Please world",
        type: "world",
        region: ["other"],
        provinces: 373,
        features: ["rivers", "shores", "water_provinces"],
        status: "completed",
        publishDate: "2025-04-21",
        lastUpdate: "2025-04-21",
        load: "mobile",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "world-3ga", "v1"],
        title: "World 3b years ago by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Unofficial world map of Paper's Please world",
        type: "world",
        region: ["other"],
        provinces: 130,
        features: ["water_provinces"],
        status: "completed",
        publishDate: "2025-04-09",
        lastUpdate: "2025-04-09",
        load: "mobile",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "authun", "v1"],
        title: "Austria-Hungaria by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Map of Austro-Hungarian Empire",
        type: "region",
        region: ["europe","balkans"],
        provinces: 1644,
        features: [],
        status: "completed",
        publishDate: "2025-01-31", 
        lastUpdate: "2025-01-31",
        load: "normal",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "world-am", "v1"],
        title: "World according to America",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "World according to America",
        type: "world",
        region: ["europe","asia", "africa", "oceania", "america"],
        provinces: 665,
        features: [],
        status: "completed",
        publishDate: "2025-01-28", 
        lastUpdate: "2025-01-28",
        load: "normal",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "panem", "v2"],
        title: "Panem v2 by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Map of Panem from Hunger Games",
        type: "country",
        region: ["america"],
        provinces: 358,
        features: [],
        status: "completed",
        publishDate: "2025-01-27", 
        lastUpdate: "2025-01-27",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "eurasia", "v2"],
        title: "Terra Eurasia by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Big detalized map of Eurasia",
        type: "continent",
        region: ["europe", "asia", "north_africa"],
        provinces: 4587,
        features: [],
        status: "completed",
        publishDate: "2024-11-29", 
        lastUpdate: "2024-11-29",
        load: "superheavy",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "mars", "v1"],
        title: "Terraformed Mars by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Map of Mars with terraformed areas",
        type: "world",
        region: ["other"],
        provinces: 438,
        features: [],
        status: "completed",
        publishDate: "2025-01-20", 
        lastUpdate: "2025-01-20",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "florida", "v1"],
        title: "Florida by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Florida",
        type: "oblast",
        region: ["america"],
        provinces: 159,
        features: [],
        status: "completed",
        publishDate: "2024-10-31", 
        lastUpdate: "2024-10-31",
        load: "ultralight",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "africa", "v3"],
        title: "Terra Africa by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Welcome to Terra Africa! This map was built to be as big as possible which is why its my new highest province map",
        type: "continent",
        region: ["africa", "middle_east", "mediterranean"],
        provinces: 1031,
        features: [],
        status: "completed",
        publishDate: "2024-10-16", 
        lastUpdate: "2024-10-29",
        load: "normal",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "australia", "v1"],
        title: "Terra Australis by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "I guess i decided that my maps should follow a naming convention so... After Terra Novus we have Terra Australis! This is a map of south east Asia and Oceania!",
        type: "continent",
        region: ["australia", "oceania", "south_east_asia"],
        provinces: 668,
        features: [],
        status: "completed",
        publishDate: "2024-10-07", 
        lastUpdate: "2024-10-07",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "america", "v2"],
        title: "Terra Novus by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "This is meine magnum opus, the Americas! This is a remake of my previous map called the Americas, this one has 2x the detail and better provinces that allow more historical boundaries.",
        type: "continent",
        region: ["americas", "north_america", "south_america", "central_america"],
        provinces: 1822,
        features: [],
        status: "completed",
        publishDate: "2024-08-22", 
        lastUpdate: "2024-10-07",
        load: "normal",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "europe1815", "v2"],
        title: "Europe 1815 by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Thankfully the German Confederation has much less chaos then the Holy Roman Empire. I hope its accurate.",
        type: "continent",
        region: ["europe"],
        provinces: 0,
        features: [],
        status: "completed",
        publishDate: "2024-07-26", 
        lastUpdate: "2024-07-26",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "usa", "v1"],
        title: "USA by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "Three maps in 3 days.",
        type: "country",
        region: ["north_america"],
        provinces: 286,
        features: [],
        status: "completed",
        publishDate: "2025-01-21", 
        lastUpdate: "2025-01-21",
        load: "mobile",
        hiddenScore: 0,
    },
    {
        id: ["pelo", "greece", "v1"],
        title: "Aegean Sea by Pelo",
        author: {
            name: "@pelo3918",
            link: "https://discord.com/users/1071700840492056717",
            color: "#3B83BD"
        },
        description: "Thankfully the German Confederation has much less chaos then the Holy Roman Empire. I hope its accurate.",
        type: "country",
        region: ["europe"],
        provinces: 311,
        features: [],
        status: "completed",
        publishDate: "2024-07-26", 
        lastUpdate: "2024-07-26",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["jaba", "america", "vg"],
        title: "America standart",
        author: {
            name: "@jaba4275",
            link: "https://discord.com/users/921793805915668520",
            color: "#3B83BD"
        },
        description: "Standart map of America",
        type: "continent",
        region: ["america", "north_america", "south_america", "central_america"],
        provinces: 430,
        features: [],
        status: "completed",
        publishDate: "2023-08-12", 
        lastUpdate: "2023-08-19",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["parkourfox", "euro4", "vg"],
        title: "Euro4 standart",
        author: {
            name: "@parkourfox",
            link: "https://discord.com/users/921793805915668520",
            color: "#3B83BD"
        },
        description: "Standart map of America",
        type: "continent",
        region: ["europe", "north_africa", "middle_east"],
        provinces: 430,
        features: [],
        status: "completed",
        publishDate: "2023-08-05", 
        lastUpdate: "2023-08-05",
        load: "light",
        hiddenScore: 0,
    },
    {
        id: ["zachary", "world", "v1"],
        title: "World by Zachary",
        author: {
            name: "@zachary.bachary",
            link: "https://discord.com/users/852608191783919676",
            color: "#3B83BD"
        },
        description: "One of the bestest world maps",
        type: "world",
        region: ["water_provinces", "islands", "straits", "rivers", "shores"],
        provinces: 2871,
        features: ["water_provinces", "islands", "straits", "rivers"],
        status: "completed",
        publishDate: "2025-02-10", 
        lastUpdate: "2025-02-10",
        load: "normal",
        hiddenScore: 150,
    },
    {
        id: ["jalhund", "europe", "vg"],
        title: "Europe Standart",
        author: {
            name: "@jalhund",
            link: "https://discord.com/users/277053272959008768",
            color: "#3B83BD"
        },
        description: "Builded-in map of Europe by game developer",
        type: "continent",
        region: ["europe"],
        provinces: 293,
        features: ["water_provinces", "islands"],
        status: "completed",
        publishDate: "1912-04-15",
        lastUpdate: "2077-01-01",
        load: "mobile",
        hiddenScore: 0,
    },
];

const mapTypes = {
    "world": "World",
    "continent": "Continent",
    "region": "Region",
    "country": "Country",
    "oblast": "Oblast",
    "district": "Disctrict",
    "city": "City",
    "custom": "Custom"
};

const mapFeatures = {
    "water_provinces": "Water Provinces",
    "islands": "Islands",
    "straits": "Straits",
    "deserts": "Deserts",
    "rivers": "Rivers",
    "terrain": "Terrain",
    "resources": "Resources"
};

const mapRegions = {
    "world": "World",
    "europe": "Europe",
    "north_africa": "North Africa",
    "middle_east": "Middle East",
    "asia": "Asia",
    "americas": "Americas",
    "africa": "Africa",
    "oceania": "Oceania"
};

const mapLoads = {
    "ultralight": "Ultra Light",
    "mobile": "Mobile",
    "light": "Light",
    "normal": "Normal",
    "heavy": "Heavy",
    "superheavy": "Super Heavy"
};

function generateDetailsLinkMap(mapId) {
    return `details.html?type=map&map=${mapId}`;
}

// Функция для генерации HTML карточки карты
function generateMapCard(map) {
    const detailsLink = generateDetailsLinkMap(map.id.join('_'));
    const imagePath = `${libLink}lib/${map.id.slice(0, 2).join('/')}/${map.id.join('_')}_!.png`;
    const awardsHTML = ''; // Can be implemented later if needed
    const status = map.status || 'completed';
    const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);

    return `
        <div class="download-card" 
            data-title="${map.title}"
            data-author="${map.author.name}" 
            data-type="${map.type}" 
            data-map-id="${map.id.join('_')}" 
            data-publish-date="${map.publishDate}"
            data-last-update="${map.lastUpdate}"
            data-score="${map.hiddenScore}"
            data-provinces="${map.provinces}" 
            data-features="${map.features.join(',')}"
            data-regions="${map.region.join(',')}"
            data-load="${map.load}"
            data-status="${map.status}"
        >
            <div class="download-info">
                <div class="download-up">
                    <div class="download-image-container">
                        <a href="${detailsLink}">
                            <img src="${imagePath}" class="download-goto-page" style="width: 250px; border-radius: 15px 15px 0 0;">
                        </a>
                        <div class="download-awards">
                            ${awardsHTML}
                        </div>
                        <div class="download-status status-${status}">
                            ${statusLabel}
                        </div>
                    </div>
                </div>
                <div class="download-center">
                    <a href="${detailsLink}" class="download-title download-goto-page" target="_blank">${map.title}</a>
                    <div class="download-row-big">
                        <div class="download-row">
                            <img src="../../img/library/autor.svg" class="download-info-ico" />
                            <a href="${map.author.link}" style="color: ${map.author.color}">${truncateAuthorName(map.author.name)}</a>
                        </div>
                        <div class="download-row">
                            <p>${map.provinces}</p>
                            <img src="../../img/library/world.svg" class="download-info-ico" />
                        </div>
                    </div>
                    <div class="download-row-big">
                        <div class="download-row">
                            <img src="../../img/library/mass.svg" class="download-info-ico" />
                            <p>${mapLoads[map.load]}</p>
                        </div>
                        <div class="download-row">
                            <p>${mapTypes[map.type] || map.type}</p>
                            <img src="../../img/library/world.svg" class="download-info-ico" />
                        </div>
                    </div>
                    <div class="download-row-big">
                        <p class="card-description">${map.description}</p>
                    </div>
                    <div class="card-features">
                        ${map.features.map(feature => `<span class="feature-tag">${mapFeatures[feature] || feature}</span>`).join(', ')}
                    </div>
                </div>
            </div>
            <div class="download-down">
                <div class="download-row-big">
                    <div class="card-regions">
                        ${map.region.map(reg => `<span class="region-tag">${mapRegions[reg] || reg}</span>`).join('')}
                    </div>
                </div>
                <div class="download-row-big">
                    <div class="download-row">
                            <img src="../../img/library/calendar.svg" class="download-info-ico" />
                        <p title="Last Update">${new Date(map.lastUpdate).toLocaleDateString()}</p>
                    </div>
                    <button class="download-download-button" onclick="downloadMapMap('${map.id.join('_')}')" style="background-color: #44944A; border-radius: 15px; width: 45px; height: 45px; border: none; cursor: pointer;">
                        <img src="../../img/library/download.svg" class="download-info-ico" />
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Функция для отображения карт с фильтрацией
function displayMaps(filters = {}) {
    const container = document.getElementById('map-cards');
    if (!container) {
        console.error('Map cards container not found');
        return;
    }

    let filteredMaps = mapsData;

    // Применяем фильтры
    if (filters.type) {
        filteredMaps = filteredMaps.filter(map => map.type === filters.type);
    }
    if (filters.author) {
        filteredMaps = filteredMaps.filter(map => map.author.name.toLowerCase().includes(filters.author.toLowerCase()));
    }
    if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        filteredMaps = filteredMaps.filter(map => 
            map.title.toLowerCase().includes(searchLower) ||
            map.description.toLowerCase().includes(searchLower)
        );
    }
    if (filters.minProvinces) {
        filteredMaps = filteredMaps.filter(map => map.provinces >= filters.minProvinces);
    }
    if (filters.regions && filters.regions.length > 0) {
        filteredMaps = filteredMaps.filter(map => 
            filters.regions.some(region => map.region.includes(region))
        );
    }
    if (filters.load) {
        filteredMaps = filteredMaps.filter(map => map.load === filters.load);
    }
    if (filters.features && filters.features.length > 0) {
        filteredMaps = filteredMaps.filter(map => 
            filters.features.every(feature => map.features.includes(feature))
        );
    }

    // Сортируем карты
    filteredMaps.sort((a, b) => b.hiddenScore - a.hiddenScore);

    // Отображаем карты
    container.innerHTML = filteredMaps.map(generateMapCard).join('');
}

// Функция для загрузки карты
async function downloadMapMap(mapId) {
    console.log(`Downloading map: ${mapId}`);
    const [author, map, version] = mapId.split('_');
    
    try {
        const fileName = `${mapId}_!.map`;
        const url = `${libLink}lib/${author}/${map}/${fileName}`;
        
        await downloadFile(url, fileName);
        downloadedMaps.add(mapId);
        console.log(`Map ${mapId} downloaded successfully`);
    } catch (error) {
        console.error(`Error downloading map ${mapId}:`, error);
        showErrorMapModal(mapId);
    }
}

// Обновляем функцию applyMapFilters чтобы использовать новые фильтры
function applyMapFilters() {
    const searchText = document.getElementById('map-lib-search').value.toLowerCase();
    const authorFilter = document.getElementById('map-lib-author-filter').value.toLowerCase();
    const typeFilter = document.getElementById('map-lib-type-filter').value;
    const loadFilter = document.getElementById('map-lib-load-filter').value;
    
    // Получаем выбранные регионы
    const selectedRegions = Array.from(document.querySelectorAll('input[name="regions"]:checked'))
        .map(cb => cb.value);
    
    // Получаем выбранные особенности
    const selectedFeatures = Array.from(document.querySelectorAll('input[name="features"]:checked'))
        .map(cb => cb.value);
    
    // Получаем минимальное количество провинций
    const provinceFilters = Array.from(document.querySelectorAll('input[name="provinces"]:checked'))
        .map(v => parseInt(v))
        .sort((a, b) => b - a);
    const minProvinces = provinceFilters[0] || 0;

    // Создаем объект с фильтрами
    const filters = {
        search: searchText,
        author: authorFilter,
        type: typeFilter,
        load: loadFilter,
        regions: selectedRegions,
        features: selectedFeatures,
        minProvinces: minProvinces
    };

    // Применяем фильтры
    displayMaps(filters);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Создаем контейнер для карт, если его нет
    const mapsDiv = document.querySelector('#maps .download-container');
    if (!mapsDiv.querySelector('#map-cards')) {
        const cardsContainer = document.createElement('div');
        cardsContainer.id = 'map-cards';
        cardsContainer.className = 'download-cards';
        mapsDiv.appendChild(cardsContainer);
    }

    // Отображаем карты
    displayMaps();
});

function getMapData(map) {
    const mapInfo = mapsData.find(m => m.id.join('_') === map);
    if (!mapInfo) {
        console.error(`Map with ID ${map} not found`);
        return null;
    }
    return mapInfo;
}